//
   Created by danne on 2016/1/15.
extends layout/default

block header
  link(rel='stylesheet', href='#{theme}/css/home.css')
  style.
    .swiper-container, .swiper-wrapper {
      width: 100%;
      height: auto;
      margin-left: auto;
      margin-right: auto;
    }

    .swiper-slide {
      height: auto;
      background-size: cover;
      background-position: center;
    }

    .swiper-slide img {
      width: 100%;
      max-height: 240px;
    }

    .floor-container {
      height: auto;
    }

    .container-col04 {
      height: auto;
    }

    .center {
      text-align: center;
      margin: 0 auto;
    }

    .box .title {
      width:50%;border-top:2px solid #f9c365;border-bottom:2px solid #f9c365;color:#f17b5f;font-size:18px;font-weight:bold;padding:10px 0;margin:15px auto;
    }
    .weui-col-50 {
      position: relative;
      margin-bottom: 10px;
      padding-bottom: 30px;
      background: #fff;
    }

    .contents .text {
      position: absolute;
      height: 30px;
      line-height: 30px;
      width: 100%;
      bottom: 0;
    }

    .buying a {
      color: #888;
    }
    .text span{color:#333;}
    span.old_price {
      font-size: .7rem;
      text-decoration: line-through;
      margin-left: 10px;
    }
    .weui-row{display: -webkit-flex;-webkit-justify-content: space-between;-webkit-flex-wrap: wrap;-webkit-align-items: flex-start;}
    .weui-row .weui-col-50{position: relative;}
    .saleOff{position:absolute;right:0;top:0;text-align:right;width:100%;}
    .saleOff img{width:50%;height:auto;}
    .weui-col-50 .img{text-align:center;}
    .weui-col-50 .img img{width:100%;}
    .more{text-align:center;width:100%;}
    .more a{display: block;padding: 10px 0;background: #f9c365;color: #f6441f; margin: 0 auto 20px;font-size: 0.9rem;border-radius: 5px;width: 90%; font-weight: bold;}

block main
  if products
    .buying.box
      .title.center
        h2 #{products.title}
      #list.contents.weui-row(style="padding:0 15px;")
        each item,idx in products.products
          if item.thumbImg && item.thumbImg.length > 0 || item.middleImgs && item.middleImgs.length
            .weui-col-50
              a(href="#{item.url}")
                if item.stockNum == 0
                  .saleOff
                    img(src="#{themeRoot}/dist/images/saleoff.png")
                .img
                  img(src='#{item.thumbImg ? item.thumbImg : (item.middleImgs && item.middleImgs.length ? item.middleImgs[0] : "")}')
                .text.center
                  span.curr_price 现价：#{item.activityPrice}元
                  span.old_price &nbsp;#{item.price}元

  if fs
    .buying.box
      .title.center
        h2 限时抢购
      #list.contents.weui-row(style="padding:0 15px;")
        each item,idx in fs
          if item.middleImgs && item.middleImgs[0]
            .weui-col-50
              a(href="#{item.url}")
                if item.stockNum == 0
                  .saleOff
                    img(src="#{themeRoot}/dist/images/saleoff.png")
                .img
                  img(src="#{item.middleImgs[0]}")
                .text.center
                  span.curr_price 现价：#{item.activityPrice}元
                  span.old_price &nbsp;#{item.price}元
      .weui-infinite-scroll(style="padding:10px 10px 20px;") 正在加载
        .infinite-preloader

block script
  script(type='text/javascript', src='/themes/jquery-weui/dist/js/jquery-weui.min.js')
  script.
    $(function () {
      var w = $('.buying').eq(0).find('.weui-col-50').eq(0).width();
      console.log(w);
      $('.box .weui-col-50').each(function () {
        $(this).find('.img').css({'width': w + 'px', 'height': w + 'px'});
      })
    });
    var loading = false, page = 1;
    $(document.body).infinite().on("infinite", function () {
      if(loading)
        return;
      loading = true;
      setTimeout(function() {
        page += 1;
        $.post('#{baseUrl}/getPros', {
          page: page
        }, function (data, status) {
          if (typeof data.error !== 'undefined') {
            var err = data.error || '已加载全部数据';
            $("#list").append('<p style="text-align:center;width:100%;">'+err+'</p>');
            loading = true;
            $('.weui-infinite-scroll').remove();
            return;
          }
            var $p = '', saleOff = '';
            data.products.forEach(function (p) {
              if(p.stockNum && p.stockNum == 0) {
                saleOff += '<div class="saleOff"><img src="/themes/dist/images/saleoff.png"></div>';
              }
              $p += '<div class="weui-col-50"><a href="' + p.url + '">'+saleOff+'<div class="img"><img src="' + p.middleImgs[0] + '"></div><div class="text center"><span class="curr_price">现价：' + p.activityPrice + '元</span><span class="old_price">&nbsp;' + p.price + '元</span></div></a></div>';
            });
            $("#list").append($p);
            loading = false;
        });
      }, 1500);
    });
