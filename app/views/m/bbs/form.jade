extends ../layouts/bbs
block header
block headNav

block content
  .section
    .heading
      .title 
        strong 发表新帖子
    .box
      form#topicForm.no-margin(method="post" action="#{contextFront}/topic/new")
        input#appid(type="hidden" name="appid" value="#{appid}")
        input#openid(type="hidden" name="openid")
        input#node(type="hidden" name="node" value="#{node}")

        .control
          textarea#content.textarea(name="content", rows="8", placeholder="输入文字发表新帖子~~~")
        .clearfix
          .control.space-sm.pull-left
            button#selectImg.btn(type="button")
              i.icon-picture
            button.btn(type="button")
              i.icon-smile
          .control.space-sm.pull-right
            a.btn(href='home/#{node}') 取消
            button.btn.primary.outline(type='submit') 发表
      .divider.space-sm
      //- .heading
        .title 
          strong 图片
      .row#images
        //- #selectImg.cell-4
          .avatar.avatar-xl(data-skin='')
            i.icon.icon-plus
block contentScripts
  script.
    var count = 0;
    var serverIds = [];
    $("body").removeClass("with-heading-top"); 
    W.config(appid);
    wx.ready(function(){
    });
    $(document).ready(function(){
      $("#selectImg").on("click", function(e){
        var that = this;
        W.chooseImage(function(localIds){
          if(localIds){
            $.each(localIds, function(index, localId){
              alert(JSON.stringify(localId));
              if(localId){
                W.uploadImage(localId, function(serverId){
                  alert(" upload image "+ localId);
                  if(serverId){
                    serverIds.push(serverId);
                    wx.getLocalImgData({
                      localId: localId, // 图片的localID
                      success: function (res) {
                        var localData = res.localData; // localData是图片的base64数据，可以用img标签显示
                        var img = "<img src='"+ localData + "'>"
                        var html = "<div class='cell-4'><div class='avatar.avatar-xl'>" + img + "</div></div>";
                        $("#images").append(html);
                      }
                    });
                  }
                });
              }
            });
              //- count++;
              //- if(count>9){
              //-   $(that).remove();
              //-   break;
              //- }
           }
        });
      });
      
      $("#topicForm").ajaxform({
        onSubmit: function(formData){
          alert(serverIds.join(','));
          formData["serverIds"] = serverIds;
        },
        onSuccess: function(data){
          console.log(data);
          window.location.href="#{contextFront}/home/#{node}"
        },
        onError: function(status){
          console.log(status);
          //- window.location.href="/home/#{node}"
        }
      });
    });

