
extends ../layouts/bbs
block headNav

block content
  div
    if(!topic)
      .article
        p 帖子不存在哦,可能已经被删除 ~~~ 
    #topic.list.space-sm 
      .item.with-avatar
        a(href="fans/#{topic.fans?topic.fans._id}")
          .avatar
            img(src='#{topic.fans?topic.fans.headimgurl:""}', alt='')

        .content
           a.title(href="fans/#{topic.fans?topic.fans._id:''}") 
            span.nickname #{topic.fans?topic.fans.nickname:(topic.user?topic.user.username:'')}
            span.label.primary.rounded(style='margin-right: 0.25rem') V. #{topic.fans?topic.fans.level:1}
            if topic.hot
              span.label.red.rounded(style='margin-right: 0.25rem') 
                i.icon-sun
           .subtitle.muted.no-margin  #{formatDate(topic.createdAt)} 浏览 #{topic.readCount?topic.readCount:0}
              
      .topic.space-sm 
        .space-sm 
          if topic.node
            span.label.primary.rounded(style='margin-right: 0.25rem')=topic.node.title
          | #{topic.content}
        if(topic.images && topic.images.length>0)
          each img in topic.images
            if img
              img.img(src='#{contextRoot}#{img}', alt='')
  div
    include commentForm    
    //- .section(data-display='modal', data-selector='.btn-reply', data-remote='/part/examples/comments-reply.html', data-placement='bottom')
    .section
      .heading
        .title
          i.icon.icon-comments-alt.muted
          strong  评论
          small.muted (#{topic.commentCount})
      .divider.no-padding.no-margin
      #comments.list.comments.small
        include comments
      nav.nav.justified.pager
        a#pagermore(href="javascript:;", data-offset="#{offset?offset:0}",data-limit="#{limit?limit:10}")
          span
            strong 更多评论 (#{topic.commentCount})
            span.text-link
              i.icon.icon-double-angle-down
  nav.fab.affix.dock-bottom.shadow-none
    //- a.btn.circle.shadow-2.has-margin-sm.dark(href='https://github.com/easysoft/mzui/blob/master//part/examples/comments.html', target='_blank')
      i.icon-code
    a.btn.circle.shadow-2.has-margin-sm.btn-lg.primary-pale(title='返回', onclick='javascript:window.history.go(-1);')
      i.icon.icon-chevron-left
    a.btn.circle.shadow-2.has-margin-sm.btn-lg.green.pull-right(href="topic/comment/new/#{topic._id}", title='评论')
      i.icon.icon-comments
block contentScripts
  script.
    var count = 0;
    var serverIds = [];
    $("body").removeClass("with-heading-top");
    $(document).ready(function(){
      $("#pagermore").on("click", function(e){
        var that = $(this);
        var offset = parseInt($(that).data("offset"));
        var limit = parseInt($(that).data("limit"));
        $.get('#{contextFront}/topic/comments/#{topic._id}',{offset:#{offset?offset:0}, limit:#{limit?limit:10}}, function(html){
          $(that).data("offset",(offset + limit));
          $("#comments").append(html);
        },'html');
      });

      $("#selectImg").on("click", function(e){
        W.chooseImage(9,function(localIds){
          syncUpload(localIds);
        });
      });
      
      $("#commentForm").ajaxform({
        onSubmit: function(formData){
          formData["serverIds"] = serverIds;
        },
        onSuccess: function(data){
          console.log(data);
          //- window.location.href="#{contextFront}/topic/comment/view/#{topicid}"
        },
        onError: function(status){
          console.log(status);
          //- window.location.href="/home/#{topicid}"
        }
      });
      function syncUpload(localIds){
        var localId = localIds.pop();
        W.uploadImage(localId, function(serverId){
          //- alert(" upload image "+ localId);
          if(serverId){
            serverIds.push(serverId);
            wx.getLocalImgData({
              localId: localId, // 图片的localID
              success: function (res) {
                var localData = res.localData; // localData是图片的base64数据,可以用img标签显示
                var img = "<img src='"+ localData + "'>"
                var html = "<div class='cell-4'><div class='avatar.avatar-xl'>" + img + "</div></div>";
                $("#images").append(html);
                if(localIds.length > 0){
                  syncUpload(localIds);
                }
              }
            });
          }
        });
      };
    });
