var weixinOauthURL="https://open.weixin.qq.com/connect/oauth2/authorize",getUserInfoOauthURL=contextRoot+"/api/getUserInfo",signatureUrl=contextRoot+"/api/jsConfig",userListUrl=contextRoot+"/api/userList",userUrl=contextRoot+"/api/getUser",userByUioinIdUrl=contextRoot+"/api/getUserByUnionId",getLatestTokenUrl=contextRoot+"/api/getLatestToken",saveUploadImgUrl=contextRoot+"/api/saveUploadImg",shortUrl=contextRoot+"/api/getShortUrl";(function(){function e(e){$.post(signatureUrl,{url:getLocationURL(),appid:e},function(e,t,n){t&&"success"==t&&e?(console.log("********* config data:"+JSON.stringify(e)),wx.config(e)):console.log("wx config error ",e,t,n)})}function t(e,t){o(e,"snsapi_userinfo",t,"userinfo")}function n(e,t){o(e,"snsapi_base",t,"base")}function o(e,t,n,o){var i=encodeURIComponent("http://9cubic.cn/wxroute/"+n.replace("https://","").replace("http://","")),r=weixinOauthURL;r+="?appid="+e,r+="&redirect_uri="+i,r+="&response_type=code",r+="&scope="+t,r+="&state="+o,r+="#wechat_redirect",window.location.href=r}function i(e,t){var o=getLocationURL(),i=getQueryString("state"),r=getQueryString("code"),u=getQueryString("wid");u||(u="");var a=localStorage.getItem(u+".user.openid");localStorage.getItem(u+".user.unionid"),localStorage.getItem(u+".user");return a&&"undefined"!=a?(console.log("获取到本地用户信息"),t(),!0):void(r&&"undefined"!=r?"base"==i&&c(e,t):n(e,o))}function r(e,n){var o=getLocationURL(),i=getQueryString("state"),r=getQueryString("code");"undefined"==typeof wid&&(wid=getQueryString("wid")),wid||(wid="");var s=localStorage.getItem(wid+".user.openid"),l=localStorage.getItem(wid+".user.unionid"),d=localStorage.getItem(wid+".user");if(s&&"undefined"!=s||l&&"undefined"!=l){if(d&&s&&""!=s&&"null"!=s)return console.log("获取到本地用户信息"),n(d?JSON.parse(d):{});if(s&&""!=s&&"null"!=s)return u(wid,s,n);if(l)return a(wid,l,n)}else r?i&&c(e,function(e){console.log("&&&&&&&&&&&&& user: ",JSON.stringify(e)),window.location.href=removeQueryString(o,["code","state"])}):t(e,o)}function c(e,t){var n=getQueryString("code");"undefined"==typeof wid&&(wid=getQueryString("wid")),wid||(wid="");var o="snsapi_"+getQueryString("state");Zepto.post(getUserInfoOauthURL,{appid:e,code:n,scope:o,wid:wid},function(e){e&&"0"==e.error&&e.result?t(s(wid,e.result)):(console.log("获取微信用户信息错误"),t(null))})}function u(e,t,n){Zepto.post(userUrl,{openid:t},function(t){n(s(e,t))})}function a(e,t,n){Zepto.post(userByUioinIdUrl,{wid:e,unionid:t},function(t){n(s(e,t))})}function s(e,t){if(!t)return t;localStorage.setItem(e+".user.openid",t.openid),localStorage.setItem(e+".user.unionid",t.unionid);var t={openid:t.openid,nickname:t.nickname,username:t.username,sex:t.sex,province:t.province,city:t.city,country:t.country,headimgurl:t.headimgurl,unionid:t.unionid};return localStorage.setItem(e+".user",JSON.stringify(t)),t}function l(e){wx.ready(function(){wx.getLocation({type:"wgs84",success:function(t){var n=t.latitude,o=t.longitude;t.speed,t.accuracy;e(n,o)},fail:function(t){e()}})})}function d(e,t,n,o,i,r,c){wx.ready(function(){wx.openLocation({latitude:e,longitude:t,name:n,address:o,scale:i,infoUrl:r})})}function g(e,t){wx.ready(function(){wx.onMenuShareAppMessage({title:e.title,desc:e.desc,link:e.link||htmlUrl,imgUrl:e.imgUrl||htmlUrl+"img/xiao_zhi_300X300.jpg",type:"link",dataUrl:"",success:function(){"undefined"!=typeof t&&t&&t()},cancel:function(){}}),wx.onMenuShareTimeline({title:e.title,link:e.link||htmlUrl,imgUrl:e.imgUrl||htmlUrl+"img/xiao_zhi_300X300.jpg",success:function(){if(e.contextRoot){$.ajax({url:e.contextRoot+"/api/save/menuShareTimeline",type:"post",data:{openid:e.openid,link:e.link,desc:e.title},success:function(e){}});var n={link:e.link,openid:e.openid,desc:e.title,type:"2"};TDAPP.onEvent(e.title,"发送到朋友圈分享",n)}"undefined"!=typeof t&&t&&t()},cancel:function(){}})})}function p(){Zepto.post(userListUrl,{},function(e){})}function f(){Zepto.post(getLatestTokenUrl,{},function(e){})}function w(e){wx.ready(function(){wx.chooseImage({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success:function(t){var n=t.localIds;e(n)}})})}function U(e,t){wx.ready(function(){wx.previewImage({current:e,urls:t})})}function m(e,t){wx.ready(function(){wx.uploadImage({localId:e,isShowProgressTips:1,success:function(e){var n=e.serverId;t(n)}})})}function y(e){wx.ready(function(){wx.scanQRCode({needResult:1,scanType:["qrCode","barCode"],success:function(t){var n=t.resultStr;e(n)}})})}function x(e){Zepto.post(saveUploadImgUrl,{serverId:e},function(e){})}function h(e,t){Zepto.post(shortUrl,{longUrl:e},function(e){t(e)})}var S={configWx:e,oauthUser:r,oauthQuiet:i,weixinShare:g,location:l,openLocation:d,userList:p,saveUploadImg:x,latestToken:f,chooseImage:w,previewImage:U,uploadImage:m,scanQRCode:y,getShortUrl:h};window.W=S})();