var weixinOauthURL="https://open.weixin.qq.com/connect/oauth2/authorize",getUserInfoOauthURL=contextRoot+"/api/getUserInfo",signatureUrl=contextRoot+"/api/jsConfig",userListUrl=contextRoot+"/api/userList",userUrl=contextRoot+"/api/getUser",userByUioinIdUrl=contextRoot+"/api/getUserByUnionId",getLatestTokenUrl=contextRoot+"/api/getLatestToken",saveUploadImgUrl=contextRoot+"/api/saveUploadImg",shortUrl=contextRoot+"/api/getShortUrl";(function(){function e(e){$.post(signatureUrl,{url:getLocationURL(),appid:e},function(e,n,t){n&&"success"==n&&e?(console.log("********* config data:"+JSON.stringify(e)),wx.config(e)):console.log("wx config error ",e,n,t)})}function n(e,n){o(e,"snsapi_userinfo",n,"userinfo")}function t(e,n){o(e,"snsapi_base",n,"base")}function o(e,n,t,o){var i=encodeURIComponent(t),r=weixinOauthURL;r+="?appid="+e,r+="&redirect_uri="+i,r+="&response_type=code",r+="&scope="+n,r+="&state="+o,r+="#wechat_redirect",window.location.href=r}function i(e,n){var o=getLocationURL(),i=getQueryString("state"),r=getQueryString("code"),c=localStorage.getItem(e+".user.openid");localStorage.getItem(e+".user.unionid"),localStorage.getItem(e+".user");return c&&"undefined"!=c?(console.log("获取到本地用户信息"),n(),!0):void(r&&"undefined"!=r?"base"==i&&a(e,n):t(e,o))}function r(e,t){var o=getLocationURL(),i=getQueryString("state"),r=getQueryString("code"),c=localStorage.getItem(e+".user.openid"),l=localStorage.getItem(e+".user.unionid"),d=localStorage.getItem(e+".user");if(c&&"undefined"!=c||l&&"undefined"!=l){if(d&&c&&""!=c&&"null"!=c)return console.log("获取到本地用户信息"),t(d?JSON.parse(d):{});if(c&&""!=c&&"null"!=c)return s(e,c,t);if(l)return u(e,l,t)}else r?i&&a(e,function(e){console.log("&&&&&&&&&&&&& user: ",JSON.stringify(e)),window.location.href=removeQueryString(o,["code","state"])}):n(e,o)}function c(e){var n=localStorage.getItem(e+".user");return n?JSON.parse(n):null}function a(e,n){var t=getQueryString("code"),o="snsapi_"+getQueryString("state");$.post(getUserInfoOauthURL,{appid:e,code:t,scope:o,appid:e},function(t){t&&"0"==t.error&&t.result?n(l(e,t.result)):(console.log("获取微信用户信息错误"),n(null))})}function s(e,n,t){$.post(userUrl,{openid:n},function(n){t(l(e,n))})}function u(e,n,t){$.post(userByUioinIdUrl,{appid:e,unionid:n},function(n){t(l(e,n))})}function l(e,n){if(!n)return n;localStorage.setItem(e+".user.openid",n.openid),localStorage.setItem(e+".user.unionid",n.unionid);var n={openid:n.openid,nickname:n.nickname,username:n.username,sex:n.sex,province:n.province,city:n.city,country:n.country,headimgurl:n.headimgurl,unionid:n.unionid};return localStorage.setItem(e+".user",JSON.stringify(n)),n}function d(e){wx.ready(function(){wx.getLocation({type:"wgs84",success:function(n){var t=n.latitude,o=n.longitude;n.speed,n.accuracy;e(t,o)},fail:function(n){e()}})})}function g(e,n,t,o,i,r,c){wx.ready(function(){wx.openLocation({latitude:e,longitude:n,name:t,address:o,scale:i,infoUrl:r})})}function p(e,n){wx.ready(function(){wx.onMenuShareAppMessage({title:e.title,desc:e.desc,link:e.link||htmlUrl,imgUrl:e.imgUrl||htmlUrl+"img/xiao_zhi_300X300.jpg",type:"link",dataUrl:"",success:function(){"undefined"!=typeof n&&n&&n()},cancel:function(){}}),wx.onMenuShareTimeline({title:e.title,link:e.link||htmlUrl,imgUrl:e.imgUrl||htmlUrl+"img/xiao_zhi_300X300.jpg",success:function(){if(e.contextRoot){$.ajax({url:e.contextRoot+"/api/save/menuShareTimeline",type:"post",data:{openid:e.openid,link:e.link,desc:e.title},success:function(e){}});var t={link:e.link,openid:e.openid,desc:e.title,type:"2"};TDAPP.onEvent(e.title,"发送到朋友圈分享",t)}"undefined"!=typeof n&&n&&n()},cancel:function(){}})})}function f(e,n){e||(e=1),e>9&&(e=9),wx.chooseImage({count:e,sizeType:["original","compressed"],sourceType:["album","camera"],success:function(e){var t=e.localIds;n(t)}})}function U(e,n){wx.ready(function(){wx.previewImage({current:e,urls:n})})}function m(e,n){wx.uploadImage({localId:e,isShowProgressTips:1,success:function(e){n(e.serverId)}})}function x(e){wx.ready(function(){wx.scanQRCode({needResult:1,scanType:["qrCode","barCode"],success:function(n){var t=n.resultStr;e(t)}})})}function y(e){$.post(saveUploadImgUrl,{serverId:e},function(e){})}function h(e,n){$.post(shortUrl,{longUrl:e},function(e){n(e)})}var I={config:e,getUser:c,oauthUser:r,oauthQuiet:i,weixinShare:p,location:d,openLocation:g,saveUploadImg:y,chooseImage:f,previewImage:U,uploadImage:m,scanQRCode:x,getShortUrl:h};window.W=I})();