var weixinOauthURL="https://open.weixin.qq.com/connect/oauth2/authorize",getUserInfoOauthURL=contextRoot+"/api/getUserInfo",signatureUrl=contextRoot+"/api/jsConfig",userListUrl=contextRoot+"/api/userList",userUrl=contextRoot+"/api/getUser",userByUioinIdUrl=contextRoot+"/api/getUserByUnionId",getLatestTokenUrl=contextRoot+"/api/getLatestToken",saveUploadImgUrl=contextRoot+"/api/saveUploadImg",shortUrl=contextRoot+"/api/getShortUrl";(function(){function e(e){$.post(signatureUrl,{url:getLocationURL(),appid:e},function(e,t,n){t&&"success"==t&&e?(console.log("********* config data:"+JSON.stringify(e)),wx.config(e)):console.log("wx config error ",e,t,n)})}function t(e,t){o(e,"snsapi_userinfo",t,"userinfo")}function n(e,t){o(e,"snsapi_base",t,"base")}function o(e,t,n,o){var i=encodeURIComponent("http://9cubic.cn/wxroute/"+n.replace("https://","").replace("http://","")),r=weixinOauthURL;r+="?appid="+e,r+="&redirect_uri="+i,r+="&response_type=code",r+="&scope="+t,r+="&state="+o,r+="#wechat_redirect",window.location.href=r}function i(e,t){var o=getLocationURL(),i=getQueryString("state"),r=getQueryString("code"),c=localStorage.getItem(e+".user.openid");localStorage.getItem(e+".user.unionid"),localStorage.getItem(e+".user");return c&&"undefined"!=c?(console.log("获取到本地用户信息"),t(),!0):void(r&&"undefined"!=r?"base"==i&&a(e,t):n(e,o))}function r(e,n){var o=getLocationURL(),i=getQueryString("state"),r=getQueryString("code"),c=localStorage.getItem(e+".user.openid"),l=localStorage.getItem(e+".user.unionid");localStorage.getItem(e+".user");if(c&&"undefined"!=c||l&&"undefined"!=l){if(c&&""!=c&&"null"!=c)return u(e,c,n);if(l)return s(e,l,n)}else r?i&&a(e,function(e){console.log("&&&&&&&&&&&&& user: ",JSON.stringify(e)),window.location.href=removeQueryString(o,["code","state"])}):t(e,o)}function c(e){var t=localStorage.getItem(e+".user");return t?JSON.parse(t):null}function a(e,t){var n=getQueryString("code"),o="snsapi_"+getQueryString("state");$.post(getUserInfoOauthURL,{appid:e,code:n,scope:o,appid:e},function(n){n&&"0"==n.error&&n.result?t(l(e,n.result)):(console.log("获取微信用户信息错误"),t(null))})}function u(e,t,n){$.post(userUrl,{openid:t},function(t){n(l(e,t))})}function s(e,t,n){$.post(userByUioinIdUrl,{appid:e,unionid:t},function(t){n(l(e,t))})}function l(e,t){if(!t)return t;localStorage.setItem(e+".user.openid",t.openid),localStorage.setItem(e+".user.unionid",t.unionid);var t={openid:t.openid,nickname:t.nickname,username:t.username,sex:t.sex,province:t.province,city:t.city,country:t.country,headimgurl:t.headimgurl,unionid:t.unionid};return localStorage.setItem(e+".user",JSON.stringify(t)),t}function d(e){wx.ready(function(){wx.getLocation({type:"wgs84",success:function(t){var n=t.latitude,o=t.longitude;t.speed,t.accuracy;e(n,o)},fail:function(t){e()}})})}function g(e,t,n,o,i,r,c){wx.ready(function(){wx.openLocation({latitude:e,longitude:t,name:n,address:o,scale:i,infoUrl:r})})}function p(e,t){wx.ready(function(){wx.onMenuShareAppMessage({title:e.title,desc:e.desc,link:e.link||htmlUrl,imgUrl:e.imgUrl||htmlUrl+"img/xiao_zhi_300X300.jpg",type:"link",dataUrl:"",success:function(){"undefined"!=typeof t&&t&&t()},cancel:function(){}}),wx.onMenuShareTimeline({title:e.title,link:e.link||htmlUrl,imgUrl:e.imgUrl||htmlUrl+"img/xiao_zhi_300X300.jpg",success:function(){if(e.contextRoot){$.ajax({url:e.contextRoot+"/api/save/menuShareTimeline",type:"post",data:{openid:e.openid,link:e.link,desc:e.title},success:function(e){}});var n={link:e.link,openid:e.openid,desc:e.title,type:"2"};TDAPP.onEvent(e.title,"发送到朋友圈分享",n)}"undefined"!=typeof t&&t&&t()},cancel:function(){}})})}function f(e,t){e||(e=1),e>9&&(e=9),wx.chooseImage({count:e,sizeType:["original","compressed"],sourceType:["album","camera"],success:function(e){var n=e.localIds;t(n)}})}function U(e,t){wx.ready(function(){wx.previewImage({current:e,urls:t})})}function m(e,t){wx.uploadImage({localId:e,isShowProgressTips:1,success:function(e){t(e.serverId)}})}function x(e){wx.ready(function(){wx.scanQRCode({needResult:1,scanType:["qrCode","barCode"],success:function(t){var n=t.resultStr;e(n)}})})}function h(e){$.post(saveUploadImgUrl,{serverId:e},function(e){})}function y(e,t){$.post(shortUrl,{longUrl:e},function(e){t(e)})}function w(){localStorage&&localStorage.clear()}var I={clear:w,config:e,getUser:c,oauthUser:r,oauthQuiet:i,weixinShare:p,location:d,openLocation:g,saveUploadImg:h,chooseImage:f,previewImage:U,uploadImage:m,scanQRCode:x,getShortUrl:y};window.W=I})();