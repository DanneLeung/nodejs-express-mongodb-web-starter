//
  Created by yu869 on 2016/3/31.
extends ../layout
block header
  link(rel="stylesheet" href="//cdn.bootcss.com/datatables/1.10.11/css/dataTables.bootstrap.min.css")
  link(href="/themes/default/plugins/uploadify/uploadify.css" rel="stylesheet" type="text/css")
//应用的page title
block pageTitle
  h1 奖品明细
    small 系统中奖品明细查看
block main
  .panel
    .panel-heading.with-border
      h3.panel-title 奖品明细

        .pull-right.panel-tools
          a#back.btn.btn-default.btn-sm(href='/activities/award/list', title='返回')
            i.fa.fa-reply
          a.btn.btn-default.btn-sm(href='/file/template/awardItem.xlsx', target='_black', title='下载模板')
            i.fa.fa-cloud-download
          a.btn.btn-default.btn-sm(href='/activities/award/item/export/#{awardId}', title='导出未使用，未领取的奖品明细')
            i.fa.fa-cloud-download 导出
          a#importModal.btn.btn-default.btn-sm(title='导入明细')
            i.fa.fa-cloud-upload
    .panel-body
      form.form-inline
        .form-group
          label.control-label(for="no")  卡号:
          input#no.form-control.required(name='no', value="#{querys ? querys.no : ''}",placeholder='卡号')
        .form-group
          a#search.btn.btn-default.btn-sm(title='查询')
            i.fa.fa-search
            span 查询

      form#itemDelForm(method='post', style='display:none', action='/activities/award/item/del')
        input#ids(type='hidden',name='ids')
        input#_csrf(type='hidden', name='_csrf', value=_csrf)

      #tableWrapper(style="display:none;")
        table#couponItemList.table.table-bordered.table-hover.table-striped
          thead
            th 卡号
            th 兑换码
            th 类型
            th 库存
            th 有效开始时间
            th 有效结束时间
            th 是否作废
            th 是否领取
            th 状态
          tbody


  #importCouponsModal.modal.fade(tabindex='-1', role='dialog')
    .modal-dialog(role="document")
      .modal-content
        .modal-header
          button.close(type="button", data-dismiss="modal", aria-label="Close")
            span(aria-hidden="true") &times;
          h4.modal-title 导入奖品明细
        .modal-body
          form#inputAwardItemForm.form-horizontal(method='post', action='/activities/award/item/importItem',enctype="multipart/form-data")
            input#_csrf(type='hidden', name='_csrf', value=_csrf)
            input#awardId(type="hidden" name='awardId' value="#{awardId}")
            .form-group
              label.control-label.col-sm-3 选择明细文件：
              .col-sm-8
                input#mfile.form-control(type="file",name='mfile')
                p.help-block 选择奖品明细的文件，进行导入
        .modal-footer
          button.btn.btn-default(type="button", data-dismiss="modal") 关闭
          button#importBtn.btn.btn-primary(type="button") 添加


//应用添加的脚本在scripts block中定义
block scripts
  script(src='//cdn.bootcss.com/datatables/1.10.11/js/jquery.dataTables.min.js')
  script(src='//cdn.bootcss.com/datatables/1.10.11/js/dataTables.bootstrap.min.js')
  script(src="//cdn.bootcss.com/bootstrap-filestyle/1.2.1/bootstrap-filestyle.min.js")
  script.
    $(document).ready(function () {

      $(".form-group").find(':file').filestyle({buttonText: '上传文件'});

      var opts = {
        "language": {
          "url": "/themes/default/plugins/datatables/Chinese.json"
        },
        autoWidth: false,
        lengthChange: false,
        searching: false,
        processing: false,
        //scrollX:true,
        serverSide: true,
        deferRender: true
      };
      var t = $('#couponItemList').DataTable($.extend(opts, {
        ajax: {url: '/activities/award/item/datatable/#{awardId}'},
        order: [[5, 'asc']],
        columns: [
          //{data: ""},
          {data: "no", defaultContent: ''},
          {data: "code", defaultContent: '', 'class': 'text-center'},
          {
            data: "type", defaultContent: '', 'class': 'text-center'
          },
          {data: "stock", defaultContent: '', 'class': 'text-center'},
          {
            data: "startTime", defaultContent: '', 'class': 'text-center', render: function (data, type, full, meta) {
              var date = "";
              if (data != null && data != undefined) {
                var b = moment(new Date(data));
                date = b.format("YYYY-MM-DD HH:mm:ss");
              }
              return date;
            }
          },{
            data: "endTime", defaultContent: '', 'class': 'text-center', render: function (data, type, full, meta) {
              var date = "";
              if (data != null && data != undefined) {
                var b = moment(new Date(data));
                date = b.format("YYYY-MM-DD HH:mm:ss");
              }
              return date;
            }
          },
          {data: "toVoid", defaultContent: '', 'class': 'text-center', render: function (data, type, full, meta) {
            var result = "";
            if (data == '1') {
              result = "<i class='fa fa-check-square'/>"
            } else {
              result = "<i class='fa fa-square-o'/>"
            }
            return result;
          }},
          {data: "taken", defaultContent: '', 'class': 'text-center', render: function (data, type, full, meta) {
            var result = "";
            if (data == '1') {
              result = "<i class='fa fa-check-square'/>"
            } else {
              result = "<i class='fa fa-square-o'/>"
            }
            return result;
          }},
          {data: "status", defaultContent: '',
            render: function (data, type, full, meta) {

              return data;
            }},
          {data: "_id", visible: false}
        ]
      })).on('draw.dt', function () {
        $("#tableWrapper").fadeIn();
      });

      $('#search').on("click", function (e) {
        var no = $('#no').val();
        var TT = $('#couponItemList').DataTable();
        TT.ajax.url('/activities/award/item/datatable/#{awardId}?no=' + no).load();
      });
      //导入
      $('#importModal').on("click", function (e) {
        $('#importCouponsModal').modal("show");
      });
      //提交导入
      $('#importBtn').on("click", function (e) {
        var file= $("#mfile").val();
        if(file){
          $('#inputAwardItemForm').submit();
        }else{
          bootbox.alert("请先选择文件！");
          return false;
        }
      });

    });
