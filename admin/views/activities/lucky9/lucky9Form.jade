//
   Created by Renee on 2016/5/10.
extends ../layout
block header
  link( rel="stylesheet",href="/themes/default/plugins/daterangepicker/daterangepicker-bs3.css")
block main
  if !lucky9.isNew
    form#userDelForm(method='post', style='display:none', action='/activities/lucky9/del')
      input#ids(type='hidden',name='ids',value="#{lucky9._id}")
      input#_csrf(type='hidden', name='_csrf', value=_csrf)

  .panel(style="position:relative;")
    .panel-heading
      h3.panel-title
        span.text-info #{lucky9.name} #{lucky9.isNew ? '创建幸运九宫格游戏' : '幸运九宫格游戏修改'}
        .panel-tools.pull-right
          a.btn.btn-default.btn-sm(href='/activities/lucky9')
            i.fa.fa-reply
          button#save.btn.btn-sm.btn-default(title="保存")
            i.fa.fa-save
    .panel-body
      form#lucky9Form.form-horizontal(method="post",action="/activities/lucky9/save",enctype='multipart/form-data')
        input#_csrf(type='hidden', name='_csrf', value=_csrf)
        if(!lucky9.isNew)
          input#id(type='hidden', name='id', value="#{lucky9._id}")

        ul.nav.nav-tabs
          li.active
            a(href='#base', data-toggle='tab') 基本参数
          li
            a(href='#media', data-toggle='tab') 图文信息
          li
            a(href='#activityInfo', data-toggle='tab') 活动信息
          //li
          //  a(href='#formfields', data-toggle='tab') 表单数据
        .tab-content.padding(style='padding:15px')
          #base.tab-pane.fade.in.active
            .form-group
              label.control-label.col-sm-2.required 名称：
              .col-sm-10
                input#name.form-control.required(type="text",name="name",value="#{lucky9.name}")
            .form-group
              label.control-label.col-sm-2.required 选择活动：
              .col-sm-10
                select#activity.form-control.required(name="activity")

            .form-group
              label.control-label.col-sm-2 可用：
              .col-sm-10
                label.checkbox
                  if (lucky9 && lucky9.enabled)
                    input#enabled(type='checkbox' name='enabled' checked="checked")
                  else
                    input#enabled(type='checkbox' name='enabled')

            .form-group
              label.control-label.col-sm-2.required 文案：
              .col-sm-10
                textarea#text.form-control.required(name="text", rows="5")
                  | #{lucky9.text ? lucky9.text : ''}
            .form-group
              label.control-label.col-sm-2.col-md-2.col-xs-12 背景图案：
              .col-sm-10
                input#bgimg.form-control(type="file",name='bgimg')
              if(lucky9.bgimg)
                .col-sm-10.col-xs-12.col-sm-offset-2
                  img#bgimgimg.img-responsive.img-thumbnail(src='#{lucky9.bgimg ? url(lucky9.bgimg.url) : ""}', width='200')

          #media.tab-pane.fade
            .form-group
              label.control-label.col-sm-2 关键字：
              .col-sm-10
                input#keywords.form-control(type="text",name="keywords",value="#{lucky9.keywords}")
                p.help-block 填写微信平台自动回复关键字,用户发送关键字则会自动图文回复回复幸运九宫格链接
            .form-group
              label.control-label.col-sm-2 标题：
              .col-sm-10
                input#title.form-control(type="text",name="title",value="#{lucky9.title}")
                p.help-block

            .form-group
              label.control-label.col-sm-2 描述：
              .col-sm-10
                textarea#description.form-control(name='description' ,rows="3")
                  | #{lucky9.description ? lucky9.description : ''}
                p.help-block 图文描述，用于分享

            .form-group
              label.control-label.col-sm-2.col-md-2.col-xs-12 上传LOGO：
              .col-sm-10
                input#log.form-control(type="file",name='logo')
                p.help-block 上传logo图片会被压缩到200X100像素,如未上传图片,将使用系统设定的LOGO
              if(lucky9.logo)
                .col-sm-10.col-xs-12.col-sm-offset-2
                  img#logoimg.img-responsive.img-thumbnail(src='#{lucky9.logo ? url(lucky9.logo.url) : ""}', width='200')

          #activityInfo.tab-pane.fade
            .alert.alert-info 关联的活动信息
            if lucky9.activity
              include ../activityInfo
block scripts
  script(src="//cdn.bootcss.com/jqueryui/1.11.4/jquery-ui.min.js")
  script(src="//cdn.ckeditor.com/4.4.3/standard/ckeditor.js")
  script(src="//cdn.bootcss.com/bootstrap-filestyle/1.2.1/bootstrap-filestyle.min.js")
  script(src="/themes/default/plugins/daterangepicker/daterangepicker.js")
  script.
    $(document).ready(function () {
      var edits = $('#edit .tbody li');
      CKEDITOR.replace('text');
      selectActivities('#{lucky9.activity ? lucky9.activity._id : ""}');
      //图片上传
      $(".form-group").find(':file').filestyle({buttonText: '上传图片'});
      //填充活动的下拉列表
      function selectActivities(id) {
        $("#activity").html("");
        $.ajax({
          url: "/activities/getActivities/",
          type: "get",
          data: {},
          success: function (data) {
            if (data) {
              $("#activity").append("<option value=''>-请选择-</option>")
              $.each(data, function (i, e) {
                if (e._id == id) {
                  $("#activity").append("<option value='" + e._id + "' selected>" + e.name + "</option>")
                } else {
                  $("#activity").append("<option value='" + e._id + "'>" + e.name + "</option>")
                }
              });
            }
          }
        });
      }

      //validator
      $('#lucky9Form').validate({
        rules: {
          name: {
            required: true,
            remote: '/activities/lucky9/checkName?oldName=#{lucky9 ? lucky9.name : ''}'
          }
        },
        messages: {
          name: {
            remote: '幸运九宫格名称已存在'
          }
        }
      });

      //动态表单部分验证
      $('#save').click(function () {
        console.log('save');
        var form = $('#lucky9Form');
        var isRepeat = [];
        var errors = [];
        $('#edit input[type!="hidden"]').each(function () {
          $(this).val($.trim($(this).val()))
          if ($.trim($(this).val()).length === 0 && $(this).attr('class').indexOf('required1') >= 0) {
            $(this).addClass('has-error').attr('placeholder', '必填').closest('.form-group').addClass('has-error');
            errors.push((this));
          }
          ;

          if ($(this).attr('class').indexOf('noRepeat') >= 0 && isRepeat.indexOf($(this).val()) >= 0) {
            $(this).removeClass('has-success').addClass('has-error').val('').attr('placeholder', '不能重复').closest('.form-group').removeClass('has-success').addClass('has-error');
            errors.push($(this));
          }
          if ($(this).attr('class').indexOf('noRepeat') >= 0 && isRepeat.indexOf($(this).val()) < 0 && $(this).val().length > 0) {
            isRepeat.push($(this).val());
          }

          if ($(this).attr('class').indexOf('chrnum') >= 0 && $(this).val().length > 0) {
            var patt = /^([a-zA-Z]+)$/;
            if (!patt.test($(this).val())) {
              $(this).removeClass('has-success').addClass('has-error').val('').closest('.form-group').removeClass('has-success').addClass('has-error').attr('placeholder', '只能写字母');
              if (errors.length <= 0) {
                errors.push($(this));
              }
            }
          }
        });
        if (errors.length > 0) {
          errors[0].focus();
          return false;
        }
        $(this).attr('disabled', 'disabled');
        form.submit();
      });

      //click换序
      $('#edit .glyphicon-arrow-down').click(function () {
        var idx = $(this).closest('li').index(), curr = $(this).closest('li');
        $('#edit .tbody li').eq(idx + 1).after(curr)
      });

      $('#edit .glyphicon-arrow-up').click(function () {
        var idx = $(this).closest('li').index(), curr = $(this).closest('li');
        $('#edit .tbody li').eq(idx - 1).before(curr);
      });
    });
