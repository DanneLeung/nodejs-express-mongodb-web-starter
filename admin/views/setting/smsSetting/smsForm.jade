//
   Created by yu869 on 2016/3/8.

//
   Created by danne on 2015/10/29.
extends ../../layouts/default
block header
  style.
    .paramsTitle, .delBody {
      margin-bottom: 10px;
    }
//应用的page title
block pageTitle
  if viewType == 'add'
    h1 短信通道新增
      small 添加短信通道信息
  if viewType == 'edit'
    h1 短信通道编辑
      small 编辑短信通道信息
  if viewType == 'view'
    h1 短信通道查看
      small 查看短信通道信息

block main
  .panel
    .panel-heading.with-border
      if viewType == 'add'
        h3.panel-title 添加短信通道信息
      if viewType == 'edit'
        h3.panel-title 编辑短信通道信息
      if viewType == 'view'
        h3.panel-title 查看短信通道信息
      .panel-tools
        a.btn.btn-default.btn-sm(href='/setting/smsSetting' title="返回")
          i.fa.fa-reply
        | &nbsp;
        if viewType == 'add' || viewType == 'edit'
          button#save.btn.btn-sm.btn-default(title="保存")
            i.fa.fa-save
        | &nbsp;
      //button.btn.btn-box-tool(data-widget="collapse")
      //  i.fa.fa-minus
    .panel-body
      form#smsForm.form-horizontal(name='smsForm', action='/setting/sms/save', method='post')
        input#_csrf(type='hidden', name='_csrf', value=_csrf)
        if viewType == 'edit'
          input#id(type='hidden', name='id', value="#{sms._id}")
        if viewType == 'add' || viewType == 'edit'
          input#type(type='hidden', name='type', value="01")
          .form-group
            label.control-label.col-md-3.required 名称：
            .col-md-8
              input#name.form-control.required(name='name', value="#{sms ? sms.name : ''}")
          .form-group
            label.control-label.col-md-3 说明：
            .col-md-8
              input#description.form-control(name='description', value="#{sms ? sms.description : ''}")
          .form-group
            label.control-label.col-sm-3 激活:
            .col-sm-8
              .checkbox.icheck
                label
                  if(sms.enabled)
                    input(type='checkbox',name="enabled", checked="checked")
                  else
                    input(type='checkbox',name="enabled")

          fieldset
            legend
              small 参数配置
            .paramsTitle.row
              .col-md-2
                label 名称
              .col-md-4
                label 值
              .col-md-2
                label 说明
              .col-md-1.text-center
                label 可编辑
              .col-md-1.text-center
                label 必须
              .col-md-2.text-center
                a.btn.btn-sm.btn-sm.plusParam
                  i.fa.fa-plus(title="添加")
            .paramsBody
              if viewType == 'edit'
                each param, index in sms.params
                  .delBody.row(id="#{param ? param._id : ''}")
                    .col-md-2
                      input#paramsId(name="paramsId" type="hidden" value="#{param ? param._id : ''}")
                      input#paramName(name="paramName" type="hidden" value="#{param ? param.paramName : ''}")
                      span(title='#{param ? param.paramName : ""}') #{param ? param.paramName : ''}
                    .col-md-4
                      input#paramValue(name="paramValue" type="hidden" value="#{param ? param.paramValue : ''}")
                      span(title='#{param ? param.paramValue : ""}') #{param ? param.paramValue : ''}
                    .col-md-2
                      input#paramDesc(name="paramDesc" type="hidden" value="#{param ? param.paramDesc : ''}")
                      span(title='#{param ? param.paramDesc : ""}') #{param ? param.paramDesc : ''}
                    .col-md-1.text-center
                      input#isChecked(name="isChecked" type="hidden" value="#{param ? param.isChecked : ''}")
                      span(title='#{param ? param.isChecked ? "是" : "否" : ""}') #{param ? param.isChecked ? "是" : "否" : ""}
                    .col-md-1.text-center
                      input#isRequired(name="isRequired" type="hidden" value="#{param ? param.isRequired : ''}")
                      span(title='#{param ? param.isRequired ? "是" : "否" : ""}') #{param ? param.isRequired == '01' ? "是" : "否" : ''}
                    .col-md-2.text-center
                      a.btn.btn-sm.btn-sm.editParam
                        i.fa.fa-wrench(title="修改")
                      | &nbsp;
                      a.btn.btn-sm.btn-sm.delParam
                        i.fa.fa-remove(title="删除")

  #paramsModal.modal.fade(tabindex='-1', role='dialog')
    .modal-dialog(role="document")
      .modal-content
        .modal-header
          button.close(type="button", data-dismiss="modal", aria-label="Close")
            span(aria-hidden="true") &times;
          h4.modal-title 属性添加
        .modal-body
          form#paramsForm.form-horizontal(name='paramsForm')
            .form-group
              label.control-label.col-md-4.required 参数名称：
              .col-md-7
                input#param_Name.form-control.required(name='param_Name', value="#{payment ? payment.paramName : ''}")

            .form-group
              label.control-label.col-md-4.required 参数值：
              .col-md-7
                input#param_Value.form-control.required(name='param_Value', value="#{payment ? payment.paramValue : ''}")

            .form-group
              label.control-label.col-md-4 参数说明：
              .col-md-7
                input#param_Desc.form-control(name='param_Desc', value="#{payment ? payment.paramDesc : ''}")

            .form-group
              label.control-label.col-md-4 可编辑：
              .col-md-7
                label
                  input#is_Checked.mini(type='checkbox' name='is_Checked' value='01')

            .form-group
              label.control-label.col-md-4 必须：
              .col-md-7
                label
                  input#is_Required.mini(type='checkbox' name='is_Required' value='01')
                  input#params_Id(type='hidden' name='params_Id')
        .modal-footer
          button.btn.btn-sm(type="button", data-dismiss="modal") 关闭
          button.addParams.btn.btn-primary(type="button") 添加


//应用添加的脚本在scripts block中定义
block scripts
  script.
    $(document).ready(function () {
      $('input').iCheck({
        checkboxClass: 'icheckbox_square-blue',
        radioClass: 'iradio_square-blue',
        increaseArea: '20%' // optional
      });

      var smsForm = $("#smsForm");
      smsForm.validate({
        rules: {
          name: {
            required: true
          }, type: {
            required: true
          }
        }
      });

      // 保存
      $('#save').on('click', function () {
        var enable = $(".mini").is(":checked");
        if (enable) {
          $("#enable").val("01");
        } else {
          $("#enable").val("00");
        }
        var index = $(".delBody").length;
        if (index < 1) {
          bootbox.alert("无参数");
        } else {
          smsForm.submit();
        }
      });

      //新增属性
      $(".paramsTitle").on("click", ".plusParam", function () {
        $("#param_Name").val("");
        $("#param_Value").val("");
        $("#param_Desc").val("");
        $("#params_Id").val("");
        $(".mini").iCheck('uncheck');
        $("#paramsModal").modal('show');
      });

      $("#paramsModal").on("click", ".addParams", function () {
        var paramsForm = $("#paramsForm");
        if (paramsForm.valid()) {
          var paramName = $("#param_Name").val();
          var paramValue = $("#param_Value").val();
          var paramDesc = $("#param_Desc").val();

          var isChecked = $("#is_Checked").is(":checked");
          var isCheckedText = "";
          if (isChecked) {
            isCheckedText = "是";
          } else {
            isCheckedText = "否";
          }
          var isRequired = $("#is_Required").is(":checked");
          var isRequiredText = "";
          if (isRequired) {
            isRequiredText = "是"
          } else {
            isRequiredText = "否"
          }

          // 如果是新增,则讲代码加入, 否则则是替换
          var editCode = "";
          var paramsId = $("#params_Id").val();
          if (paramsId) {
            $("#" + paramsId).remove();
            editCode = '<div class="">'
                    + '<a class="btn btn-sm btn-sm editParam">'
                    + '<i class="fa fa-wrench" title="修改"></i>'
                    + '</a>&nbsp'
                    + '<a class="btn btn-sm btn-sm delParam">'
                    + '<i class="fa fa-remove" title="删除"></i></a></div>';
          } else {
            editCode = '<a class="btn btn-sm btn-sm delParam">'
                    + '<i class="fa fa-remove" title="删除"></i></a>';
          }

          var temp = '<div class="delBody row" id="' + paramsId + '">' +
                  '<div class="col-md-2" >' +
                  '<span title="' + paramName + '">' + paramName + '</span>' +
                  '<input type="hidden" name="paramName" id="paramName" value="' + paramName + '">' +
                  '<input type="hidden" name="paramsId" id="paramsId" value="' + paramsId + '">' +
                  '</div>' +
                  '<div class="col-md-4" >' +
                  '<span title="' + paramValue + '">' + paramValue + '</span>' +
                  '<input type="hidden" name="paramValue" id="paramValue" value="' + paramValue + '">' +
                  '</div>' +
                  '<div class="col-md-2" >' +
                  '<span title="' + paramDesc + '">' + paramDesc + '</span>' +
                  '<input type="hidden" name="paramDesc" id="paramDesc" value="' + paramDesc + '">' +
                  '</div>' +
                  '<div class="col-md-1 text-center" >' +
                  '<span title="' + isCheckedText + '">' + isCheckedText + '</span>' +
                  '<input type="hidden" name="isChecked"  id="checked" value="' + isChecked + '">' +
                  '</div>' +
                  '<div class="col-md-1 text-center" >' +
                  '<span title="' + isRequiredText + '">' + isRequiredText + '</span>' +
                  '<input type="hidden" name="isRequired" id = "isRequired" value="' + isRequired + '">' +
                  '</div>' +
                  '<div class="col-md-2 text-center">' +
                  editCode +
                  '</div>' +
                  '</div>';


          $(".paramsBody").append(temp);
          $('#paramsModal').modal('hide')
        }
      });


      //删除属性
      $(".paramsBody").on("click", ".delParam", function () {
        $(this).parents(".delBody").remove();
      });

      //编辑属性
      $(".paramsBody").on("click", ".editParam", function () {
        var body = $(this).parents(".delBody");
        var paramName = body.find('#paramName').val();
        var paramValue = body.find('#paramValue').val();
        var paramDesc = body.find('#paramDesc').val();
        var paramsId = body.find('#paramsId').val();
        $("#params_Id").val(paramsId);
        $("#param_Name").val(paramName);
        $("#param_Value").val(paramValue);
        $("#param_Desc").val(paramDesc);
        $(".addParams").text("修改")
        $("#paramsModal").modal('show');
      });
    });
