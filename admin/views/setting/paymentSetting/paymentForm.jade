//
   Created by yu869 on 2016/3/8.

//
   Created by danne on 2015/10/29.
extends ../../layouts/default
block header
     link(href="/themes/default/plugins/uploadify/uploadify.css" rel="stylesheet" type="text/css")

//应用的page title
block pageTitle
   if viewType == 'add'
      h1 支付方式新增
         small 添加支付方式信息
   if viewType == 'edit'
      h1 支付方式编辑
         small 编辑支付方式信息
   if viewType == 'view'
      h1 支付方式查看
         small 查看支付方式信息

block main
   .panel
      .panel-heading.with-border
         if viewType == 'add'
            h3.panel-title 添加支付方式信息
         if viewType == 'edit'
            h3.panel-title 编辑支付方式信息
         if viewType == 'view'
            h3.panel-title 查看支付方式信息
         .panel-tools
            button.btn.btn-sm.btn-default.backToList(title="返回")
               i.fa.fa-reply
            | &nbsp;
            if viewType == 'add' || viewType == 'edit'
               button#save.btn.btn-sm.btn-default(title="保存")
                  i.fa.fa-save
            | &nbsp;
         //button.btn.btn-box-tool(data-widget="collapse")
         //  i.fa.fa-minus
      .panel-body
         div.row
            form#paymentForm.form-horizontal(name='paymentForm', action='/setting/payment/save', method='post')
               input#_csrf(type='hidden', name='_csrf', value=_csrf)
               if viewType == 'edit'
                  input#id(type='hidden', name='id', value="#{payment._id}")
               if viewType == 'add' || viewType == 'edit'
                  .form-group
                     label.control-label.col-md-3.required 名称：
                     .controls.col-md-9
                        input#name.form-control.required(name='name', value="#{payment ? payment.name : ''}")

                  .form-group
                     label.control-label.col-md-3 备注：
                     .controls.col-md-9
                        input#description.form-control(name='description', value="#{payment ? payment.description : ''}")

                  fieldset
                     legend 参数：
                     .panel-body.row
                        .paramsTitle.row
                           .col-md-2
                              | 参数名称:
                           .col-md-2
                              | 参数值:
                           .col-md-4
                              | 说明:
                           .col-md-2.text-center
                              | 渠道商设定:
                           .col-md-1.text-center
                              | 必须:
                           .col-md-1.text-center
                              a.btn.btn-sm.plusParam
                                 i.fa.fa-plus(title="添加")
                        .paramsBody

                           if viewType == 'edit'
                              each val, index in payment.params
                                 .delBody.row(id="#{val ? val._id : ''}")
                                    .col-md-2(style="overflow: hidden")
                                       input#paramsId(name="paramsId" type="hidden" value="#{val ? val._id : ''}")
                                       input#paramName(name="paramName" type="hidden" value="#{val ? val.paramName : ''}")
                                       label(title='#{val ? val.paramName : ""}') #{val ? val.paramName : ''}
                                    .col-md-2(style="overflow: hidden")
                                       input#paramValue(name="paramValue" type="hidden" value="#{val ? val.paramValue : ''}")
                                       label(title='#{val ? val.paramValue : ""}') #{val ? val.paramValue : ''}
                                    .col-md-4(style="overflow: hidden")
                                       input#paramDesc(name="paramDesc" type="hidden" value="#{val ? val.paramDesc : ''}")
                                       label(title='#{val ? val.paramDesc : ""}') #{val ? val.paramDesc : ''}
                                    .col-md-2.text-center(style="overflow: hidden")
                                       input#isChecked(name="isChecked" type="hidden" value="#{val ? val.isChecked : ''}")
                                       label(title='#{val ? val.isChecked == "01" ? "可设定" : "不可设定" : ""}') #{val ? val.isChecked == "01" ? "可设定" : "不可设定" : ""}
                                    .col-md-1.text-center(style="overflow: hidden")
                                       input#isRequired(name="isRequired" type="hidden" value="#{val ? val.isRequired : ''}")
                                       label(title='#{val ? val.isRequired == "01" ? "是" : "否" : ""}') #{val ? val.isRequired == '01' ? "是" : "否" : ''}
                                    .col-md-1.text-center
                                       .row
                                          a.btn.btn-sm.editParam
                                             i.fa.fa-wrench(title="修改")
                                          | &nbsp;
                                          a.btn.btn-sm.delParam
                                             i.fa.fa-remove(title="删除")


   #paramsModal.modal.fade(tabindex='-1', role='dialog')
      .modal-dialog(role="document")
         .modal-content
            .modal-header
               button.close(type="button", data-dismiss="modal", aria-label="Close")
                  span(aria-hidden="true") &times;
               h4.modal-title 属性添加
            .modal-body
               form#paramsForm.form-horizontal(name='paramsForm')
                  .form-group
                     label.control-label.col-md-4.required 参数名称：
                     .controls.col-md-7
                        input#param_Name.form-control.required(name='param_Name', value="#{payment ? payment.paramName : ''}")

                  .form-group
                     label.control-label.col-md-4.required 参数值：
                     .controls.col-md-7
                        input#param_Value.form-control.required(name='param_Value', value="#{payment ? payment.paramValue : ''}")

                  .form-group
                     label.control-label.col-md-4 参数说明：
                     .controls.col-md-7
                        input#param_Desc.form-control(name='param_Desc', value="#{payment ? payment.paramDesc : ''}")

                  .form-group
                     label.control-label.col-md-4 可编辑：
                     .controls.col-md-7
                        label
                           input#is_Checked.mini(type='checkbox' name='is_Checked' value='01')

                  .form-group
                     label.control-label.col-md-4 必须：
                     .controls.col-md-7
                        label
                           input#is_Required.mini(type='checkbox' name='is_Required' value='01')
                           input#params_Id(type='hidden' name='params_Id')
            .modal-footer
               button.btn.btn-default(type="button", data-dismiss="modal") 关闭
               button.addParams.btn.btn-primary(type="button") 添加




//应用添加的脚本在scripts block中定义
block scripts
   script(src="/themes/default/plugins/uploadify/jquery.uploadify.min.js")
   script(src="/themes/default/plugins/uploadify/dora.public.js")
   script.
      $(document).ready(function () {
         $('input').iCheck({
            checkboxClass: 'icheckbox_square-blue',
            radioClass: 'iradio_square-blue',
            increaseArea: '20%' // optional
         });

         // 上传
         initUploadFyBtn('certificateUpload','certificate','',function(data){
            $("#certificate").val(data[0].url);
         });

         var paymentForm = $("#paymentForm");
         paymentForm.validate({
            rules: {
               name: {
                  required: true
               },
               certificate: {
                  required: true
               }
            }
         });

         // 保存
         $('#save').on('click', function () {
            var enable = $(".mini").is(":checked");
            if (enable){
               $("#enable").val("01");
            } else {
               $("#enable").val("00");
            }
            var index = $(".delBody").length;
            if (index < 1){
               bootbox.alert("无参数");
            } else {
               paymentForm.submit();
            }
         });

         //新增属性
         $(".paramsTitle").on("click", ".plusParam", function () {
            $("#param_Name").val("");
            $("#param_Value").val("");
            $("#param_Desc").val("");
            $("#params_Id").val("");
            $(".mini").iCheck('uncheck');
            $("#paramsModal").modal('show');
         });

         $("#paramsModal").on("click", ".addParams", function () {
            var paramsForm = $("#paramsForm");
            if(paramsForm.valid()) {
               var paramName = $("#param_Name").val();
               var paramValue = $("#param_Value").val();
               var paramDesc = $("#param_Desc").val();
               var isChecked = $("#is_Checked").is(":checked");
               var isCheckedText = "";
               if (isChecked){
                  isChecked = "01";
                  isCheckedText = "可设定";
               } else {
                  isChecked = "00";
                  isCheckedText = "不可设定";
               }
               var isRequired = $("#is_Required").is(":checked");
               var isRequiredText = "";
               if (isRequired){
                  isRequired = "01";
                  isRequiredText = "是"
               } else {
                  isRequired = "00";
                  isRequiredText = "否"
               }

               // 如果是新增,则讲代码加入, 否则则是替换
               var editCode = "";
               var paramsId = $("#params_Id").val();
               if (paramsId) {
                  $("#" + paramsId).remove();
                  editCode = '<div class="row">'
                          +'<a class="btn btn-sm editParam">'
                          +'<i class="fa fa-wrench" title="修改"></i>'
                          +'</a>&nbsp'
                          +'<a class="btn btn-sm delParam">'
                          +'<i class="fa fa-remove" title="删除"></i></a></div>';
               } else {
                  editCode = '<a class="btn btn-sm delParam">'
                  + '<i class="fa fa-remove" title="删除"></i></a>';
               }

               var temp = '<div class="delBody row" id="'+paramsId+'">' +
                       '<div class="col-md-2" style="overflow: hidden">' +
                       '<label title="'+paramName+'">' + paramName + '</label>' +
                       '<input type="hidden" name="paramName" id="paramName" value="'+paramName+'">' +
                       '<input type="hidden" name="paramsId" id="paramsId" value="'+paramsId+'">' +
                       '</div>' +
                       '<div class="col-md-2" style="overflow: hidden">' +
                       '<label title="'+paramValue+'">' + paramValue + '</label>' +
                       '<input type="hidden" name="paramValue" id="paramValue" value="'+paramValue+'">' +
                       '</div>' +
                       '<div class="col-md-4" style="overflow: hidden">' +
                       '<label title="'+paramDesc+'">' + paramDesc + '</label>' +
                       '<input type="hidden" name="paramDesc" id="paramDesc" value="'+paramDesc+'">' +
                       '</div>' +
                       '<div class="col-md-2 text-center" style="overflow: hidden">' +
                       '<label title="'+isCheckedText+'">' + isCheckedText + '</label>' +
                       '<input type="hidden" name="isChecked"  id="checked" value="'+isChecked+'">' +
                       '</div>' +
                       '<div class="col-md-1 text-center" style="overflow: hidden">' +
                       '<label title="'+isRequiredText+'">' + isRequiredText + '</label>' +
                       '<input type="hidden" name="isRequired" id = "isRequired" value="'+isRequired+'">' +
                       '</div>' +
                       '<div class="col-md-1 text-center">' +
                           editCode +
                       '</div>' +
                       '</div>';


               $(".paramsBody").append(temp);
               $('#paramsModal').modal('hide');
            }
         });

         //删除属性
         $(".paramsBody").on("click", ".delParam", function () {
            $(this).parents(".delBody").remove();
         });

         $(".backToList").on("click", function(){
            var name = $("#name").val();
            var index = $(".delBody").length;
            var viewType = '#{viewType}';
            if (viewType == 'add') {
               if (name || index > 0){
                  bootbox.confirm("已有数据填入,是否返回?", function (result) {
                     if (result) {
                        window.location = "/setting/paymentSetting";
                     }
                  });
               } else {
                  window.location = "/setting/paymentSetting";
               }
            } else {
               window.location = "/setting/paymentSetting";
            }
         })

         //编辑属性
         $(".paramsBody").on("click", ".editParam", function () {
            var body = $(this).parents(".delBody");
            var paramName = body.find('#paramName').val();
            var paramValue = body.find('#paramValue').val();
            var paramDesc = body.find('#paramDesc').val();
            var isChecked = body.find('#isChecked').val();
            var isRequired = body.find('#isRequired').val();
            var paramsId = body.find('#paramsId').val();

            $("#params_Id").val(paramsId);

            $("#param_Name").val(paramName);
            $("#param_Value").val(paramValue);
            $("#param_Desc").val(paramDesc);
            if(isChecked == '01') {
               $("#is_Checked").iCheck("check")
            } else {
               $("#is_Checked").iCheck("uncheck")
            }
            if (isRequired == '01') {
               $("#is_Required").iCheck("check")
            } else {
               $("#is_Required").iCheck("uncheck")
            }
            $(".addParams").text("修改")
            $("#paramsModal").modal('show');
         });

         $("#param_Name").on('change', function(){
            var name = $(this).val();
            $("#paramName").each(function(item, value){
               if (name == $(value).val()){
                  console.log(111);
               }
            })
         })
      });
