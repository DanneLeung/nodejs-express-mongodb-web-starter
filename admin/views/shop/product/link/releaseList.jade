//
   Created by danne on 2015/10/24.
extends layout
block header
  link( rel="stylesheet" href="//cdn.bootcss.com/datatables/1.10.11/css/dataTables.bootstrap.min.css")
  link( rel="stylesheet" href="//cdn.bootcss.com/bootstrap-datepicker/1.6.0/css/bootstrap-datepicker3.min.css")
//应用的page title
block pageTitle
  h1 发布信息查看
    small 系统中产品发布信息
block main
  .panel
    .panel-heading.with-border
      h3.panel-title 产品发布
    .panel-body
      form.form-inline
        .form-group
          label.control-label(for="title")  标题:
          input#title.form-control.required(name='title', value="",placeholder='标题')
        .form-group
          label.control-label(for="time")  生成时间:
          input#time.form-control.required(name='time', value="",placeholder='点击选时间')
        .form-group
          a#search.btn.btn-default.btn-sm(title='查询')
            i.fa.fa-search
            span 查询
      form#delForm(method='post', style='display:none', action='/shop/product/link/delRelease')
        input#ids(type='hidden',name='ids')
        input#_csrf(type='hidden', name='_csrf', value=_csrf)
      #tableWrapper(style="display:none")
        table#releaseList.table.table-bordered.table-hover.table-striped
          thead
            th 标题
            th.text-center 创建时间
            th.text-center 发布
            th.text-center(width="200") 操作
          tbody

//应用添加的脚本在scripts block中定义
block scripts
  script(src='//cdn.bootcss.com/datatables/1.10.11/js/jquery.dataTables.min.js')
  script(src='//cdn.bootcss.com/datatables/1.10.11/js/dataTables.bootstrap.min.js')
  script(src='/themes/default/plugins/datepicker/bootstrap-datepicker.js')
  script.
    $(document).ready(function () {
      pageSelect();//发布位置的选项
      var startDate = $('#time').datepicker({
        format: "yyyy-mm-dd",
        language: 'cn',
        weekStart: 1,
        autoclose: true,
        todayBtn: 'linked'
      }).on('changeDate', function (ev) {
      });

      var opts = {
        "language": {
          "url": "/themes/default/plugins/datatables/Chinese.json"
        },
        autoWidth: false,
        lengthChange: false,
        searching: false,
        processing: false,
        //scrollX:true,
        serverSide: true,
        deferRender: true

      };
      var t = $('#releaseList').DataTable($.extend(opts, {
        ajax: {url: '/shop/product/link/Rdatatable'},
        order: [[2, 'desc']],
        columnDefs: [
          //{targets: 0, visible: true, sortable: false, searchable: false, className: 'text-right', defaultContent: ''},
          {
            targets: -1, visible: true, sortable: false, className: 'text-center',
            render: function (data, type, row) {
              var re = "<div class='btn-group'> <a class='btn btn-sm btn-default search' title='查看列表' href='/shop/product/link/findProduct/" + row._id + "'><i class='fa fa-list'></i></a>";
              if (row.published == 1) {
                re += "<a class='btn btn-sm btn-default search' title='取消发布' href='/shop/product/link/cancelRelease/" + row._id + "'><i class='fa fa-times-circle-o'></i></a>";
              } else {
                re += "<button class='btn btn-sm btn-default del' title='删除发布信息' type='button'><i class='fa fa-trash-o'></i></button>" +
                        "<a class='btn btn-sm btn-default' title='点击发布' href='/shop/product/link/setPosition/" + row._id + "'><i class='fa fa-registered'></i></button>";
              }
              re += '</div>';
              return re;
            }
          }
        ],
        columns: [
          //{data: ""},
          {data: "title", defaultContent: ''},
          {
            data: "createdAt", defaultContent: '', 'class': 'text-center', render: function (data, type, full, meta) {
            var b = moment(new Date(data));
            var date = "";
            if (data != null) {
              date = b.format("YYYY-MM-DD HH:mm:ss");
            }
            return date;
          }
          },
          {
            data: "published", defaultContent: '', 'class': 'text-center', render: function (data, type, full, meta) {
            return data == 1 ? "是" : "否";
          }
          },
          {data: "", defaultContent: ''}
        ]
      })).on('draw.dt', function () {
        $('#tableWrapper').fadeIn();
      });
      $('#search').on("click", function (e) {
        var title = $('#title').val();
        var time = $('#time').val();
        var TT = $('#releaseList').DataTable();
        TT.ajax.url('/shop/product/link/Rdatatable?title=' + title + '&time=' + time).load();
      });
      $('#releaseList').on('click', 'button.del', function () {
        var id = t.row($(this).parents('tr')).data()._id;
        $("#delForm #ids").val(id);
        if (id) {
          bootbox.confirm("确定要删除数据吗?", function (result) {
            if (result) {
              $("#delForm").submit();
            }
          });
        }
      });
      $('#releaseList').on('click', 'button.release', function () {
        var id = t.row($(this).parents('tr')).data()._id;
        if (id) {
          $("#positionForm #releaseIds").val(id);
          $("#releaseModal").modal('show');
        }
      });

      var form = $('#positionForm');
      form.validate({
        rules: {
          position: {
            required: true
          }
        }
      });
      $("#positionBtn").on("click", function (e) {
        form.submit();
      });
    });
    function pageSelect(){
      $.get('/shop/product/page/getPages', {}, function (data, status) {
        if(status){
          $.each(data,function(i,e){
            $("#page").append("<option value='" + e._id + "'>" + e.title + "</option>");
          });
        }
      });
    }
