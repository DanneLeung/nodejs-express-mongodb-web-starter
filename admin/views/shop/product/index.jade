//
   Created by pc on 2015/10/27.

extends layout
block header
  link( rel="stylesheet" href="//cdn.bootcss.com/datatables/1.10.11/css/dataTables.bootstrap.min.css")
block pageTitle
  h1 商品列表
block main
  .panel
    .panel-heading
      h3.panel-title 产品列表
      .panel-tools
        a.btn.btn-sm.btn-primary(href="#{baseUrl}/add")
          i.fa.fa-plus.fa-fw
          | 添加商品

    .panel-body
      #tableWrapper(style="display:none")
        table#productList.table.table-bordered.table-hover.table-striped
          thead
            th
              input#selectAll(type="checkbox" title="全选")
            th 商品图
            th 编号
            th 名称
            th 售价
            th 库存
            th 上架日期
            th 状态
            th 激活/隐藏
            th.text-center 操作
          tbody


    form#delForm(method='post', style='display:none', action='#{baseUrl}/del')
      input#ids(type='hidden',name='ids')
      input#_csrf(type='hidden', name='_csrf', value=_csrf)

    #releaseModal.modal.fade.createInvoice(tabindex="-1", role="dialog", aria-labelledby="releaseModal", aria-hidden='true')
      .modal-dialog
        .modal-content
          .modal-header
            button.close(type="button",data-dismiss="modal", aria-label="Close")
              span(aria-hidden="true") &times;
            h4.modal-title 上架
          .modal-body
            form#circleUpForm.form-horizontal(method='post', action='/shop/product/up')
              input#id(type='hidden',name='id')
              input#_csrf(type='hidden', name='_csrf', value=_csrf)
              .form-group
                label.control-label.col-md-2.required 上架时间:
                .controls.col-md-8
                  input#time.form-control.required(name='time', value="",placeholder='点击选时间')
          .modal-footer
            .center-block
            a#positionBtn.btn.btn-primary 确定
block scripts
  script(src='//cdn.bootcss.com/datatables/1.10.11/js/jquery.dataTables.min.js')
  script(src='//cdn.bootcss.com/datatables/1.10.11/js/dataTables.bootstrap.min.js')
  script(src='/themes/default/plugins/datepicker/bootstrap-datepicker.js')
  script.
    $(document).ready(function () {

      var startDate = $('#time').datepicker({
        format: "yyyy-mm-dd",
        language: 'cn',
        weekStart: 1,
        autoclose: true,
        todayBtn: 'linked'
      }).on('changeDate', function (ev) {
      });

      var table1 = $('#productList').DataTable({
        "language": {
          "url": "/themes/default/plugins/datatables/Chinese.json"
        },
        lengthMenu: [50],
        autoWidth: false,
        lengthChange: false,
        searching: false,
        serverSide: true,
        ordering: true,
        order: [[2, 'asc']],
        ajax: {url: '/shop/product/datatable?init=1&activityType=' + $("#activityType").val()},
        columnDefs: [
          //{targets: 0, visible: true, sortable: false, searchable: false, className: 'text-right', defaultContent: ''},
          {
            targets: -1, visible: true, sortable: false, className: 'text-center',
            render: function (data, type, row) {
              var btns = "<div class='btn-group'>" +
                "<a class='btn btn-sm btn-default' href='/shop/product/edit/" + row._id + "'><i class='fa fa-pencil'></i> </a>" +
                "<a class='btn btn-sm btn-default key del' title='删除' ><i class='fa fa-trash'></i></a>";
              if (row.avaliable == true) {
                btns += "<a class='btn btn-sm btn-default circleDown' title='下架'><i class='fa fa-arrow-circle-down '></i></a>";
              } else {
                btns += "<a class='btn btn-sm btn-default key circleUp' title='上架' ><i class='fa fa-arrow-circle-up'></i></a>";
              }
              btns += "</div>";
              return btns;
            }
          }
        ],
        columns: [
          {
            data: "_id", sortable: false, render: function (data, type, row) {
            return '<input type="checkbox" class="select" name="Ids" value="' + data + '">';
          }
          },
          {
            data: "thumbImage", defaultContent: '', render: function (data, type, full, meta) {
            var r = data ? "<img width=50 src='" + data + "'/>" : "";
            return r;
          }
          },
          {data: "no", defaultContent: ''},
          {data: "name", defaultContent: ''},
          {
            data: "price", defaultContent: '', 'class': 'text-right',
            render: function (data, type, full, meta) {
              return data ? data.toFixed(2) : "";
            }
          },
          {data: "quantity", defaultContent: '', 'class': 'text-center'},
          {
            data: "date_avaliable", defaultContent: '', render: function (data, type, full, meta) {
            var b = moment(new Date(data));
            var date = "";
            if (data != null) {
              date = b.format("YYYY-MM-DD HH:mm:ss");
            }
            return date;
          }
          },
          {
            data: "avaliable", defaultContent: '', 'class': 'text-center', render: function (data, type, full, meta) {
            var result = "";
            if (data == true) {
              result = "上架"
            } else {
              result = "下架"
            }
            return result;
          }
          },
          {
            data: "enabled", defaultContent: '', 'class': 'text-center', render: function (data, type, full, meta) {
            var result = "";
            if (data == true) {
              result = "<a class='btn btn-default btn-sm key' title='激活/禁用' href='/shop/product/enable/" + full._id + "'><i class='fa fa-check-square'/></a>"
            } else {
              result = "<a class='btn btn-default btn-sm key' title='激活/禁用' href='/shop/product/enable/" + full._id + "'><i class='fa fa-square-o'/></a>"
            }
            return result;
          }
          },
          {data: ""}
        ]
      }).on('draw.dt', function () {
        $('#tableWrapper').fadeIn();
      });
      $('#productList').on('click', 'a.del', function () {
        var id = table1.row($(this).parents('tr')).data()._id;
        $("#delForm #ids").val(id);
        if (id) {
          bootbox.confirm("确定要删除数据吗?", function (result) {
            if (result) {
              $("#delForm").submit();
            }
          });
        }
      });
      $('#productList').on('click', 'a.circleDown', function () {
        var id = table1.row($(this).parents('tr')).data()._id;
        if (id) {
          bootbox.confirm("确定要将该产品下架吗?", function (result) {
            if (result) {
              window.location.href = '/shop/product/down/' + id;
            }
          });
        }
      });
      $('#productList').on('click', 'a.circleUp', function () {
        var id = table1.row($(this).parents('tr')).data()._id;
        $("#circleUpForm #id").val(id);
        if (id) {
          $("#releaseModal").modal('show');
        }
      });
      $('#positionBtn').on('click', function () {
        $("#circleUpForm").submit();
      });

      //筛选
      $('#search').on("click", function (e) {
        var data = $('#searchForm').serialize();
        var startDate = $('#startDate').val();
        var endDate = $('#endDate').val();

        if ((startDate != "" && endDate == "") || (startDate == "" && endDate != "")) {
          $("#errStart").html("请同时选择两个时间");
          return false;
        } else {
          $("#errStart").html("");
        }
        if (startDate > endDate) {
          $("#errStart").html("结束时间时间应晚于等于开始时间");
          return false;
        } else {
          $("#errStart").html("");
        }

        var TT = $('#productList').DataTable();
        TT.ajax.url('/shop/product/datatable?data=null&' + data).load();
      });

    });


