extends ../layout
block header
//应用的page title
block pageTitle
  if sms.isNew
    h1 短信通道新增
      small 添加短信通道信息
block main
  .panel
    .panel-heading.with-border
      if sms.isNew
        h3.panel-title 添加短信通道信息
      .panel-tools
        a.btn.btn-sm.btn-default(href='/system/sms' title="返回")
          i.fa.fa-reply
          span  返回
        | &nbsp;
        if sms.isNew || !sms.isNew
          button#save.btn.btn-sm.btn-default(title="保存")
            i.fa.fa-save
            span  保存
        | &nbsp;
      //button.btn.btn-box-tool(data-widget="collapse")
      //  i.fa.fa-caret-left
    .panel-body
      div#userEdit.row
        .col-md-12
          form#smsForm.form-horizontal(name='smsForm', action='/system/sms/save', method='post')
            input#_csrf(type='hidden', name='_csrf', value=_csrf)

            .form-group
              label.required.control-label.col-md-3 短信通道：

              .controls.col-md-8
                select#smsMethod.form-control.required(name='smsMethod')
                  option(value="") 请选择可用短信通道
                  each ms , i in smss
                    option(value='#{ms._id}') #{ms.name}

            .canModifyParams


//应用添加的脚本在scripts block中定义
block scripts
  script.
    $(document).ready(function () {
      $('input').iCheck({
        checkboxClass: 'icheckbox_square-blue',
        radioClass: 'iradio_square-blue',
        increaseArea: '20%' // optional
      });

      $("#smsForm").validate({
        rules: {
          smsMethod: {
            required: true,
            remote: '/system/sms/checkSmsExist'
          }
        },
        messages: {
          smsMethod: {remote: "该短信通道已配置"},
        }
      });

      $("#smsMethod").on('change', function () {
        $(".canModifyParams").html("");
        var id = $(this).val();
        $.ajax({
          type: 'get', //数据发送方式
          url: '/system/sms/getCanModifyParams',
          data: {"id": id}, //要传递的数据
          success: function (data) { //成功
            if (data) {
              var html = "";
              $.each(data,function(i,item) {

                var isRequired = item.isRequired;
                var isChecked = item.isChecked;

                if (isRequired) {
                  html = html + '<div class="form-group">' +
                          '<label class="control-label col-md-3 required">' + item.paramName + '：';
                } else {
                  html = html + '<div class="form-group">' +
                          '<label class="control-label col-md-3">' + item.paramName + '：';
                }

                html = html + '</label><div class="controls col-md-8">';
                if(isChecked){
                  if (isRequired) {
                    html = html + '<input id="' + item._id + '" name="' + item._id + '" value="' + item.paramValue + '" class="form-control required">'
                  } else {
                    html = html + '<input id="' + item._id + '" name="' + item._id + '" value="' + item.paramValue + '" class="form-control">'
                  }
                }else{
                  if (isRequired) {
                    html = html + '<input id="' + item._id + '" name="' + item._id + '" value="' + item.paramValue + '" readonly class="form-control">'
                  } else {
                    html = html + '<input id="' + item._id + '" name="' + item._id + '" value="' + item.paramValue + '" readonly class="form-control">'
                  }
                }

                html = html + '</div></div>';
              })

              $(".canModifyParams").append(html);
            }
          }
        });
      })

      // 保存
      $('#save').on('click', function () {
        var enable = $(".mini").is(":checked");
        if (enable) {
          $("#enable").val("01");
        } else {
          $("#enable").val("00");
        }
        var form = $("#smsForm");
        if (form.valid()) {
          form.submit();
        }
      });

    });
