//
   Created by danne on 2015/10/24.
extends layout
block header
  link(rel="stylesheet" href="//cdn.bootcss.com/datatables/1.10.11/css/dataTables.bootstrap.min.css")
  link( rel="stylesheet" href="/themes/default/plugins/datatables/select.bootstrap.min.css" type="text/css")
  link( rel="stylesheet" href="/themes/default/plugins/select2/select2.min.css")

//应用的page title
block pageTitle
  h1 预约服务项记录管理
    small 添加，删除，更新系统中服务项信息

block main
  .panel
    .panel-heading.with-border
      h3.panel-title 预约服务项，默认显示未处理状态
      .panel-tools.pull-right
        button#handle.btn.btn-sm.btn-default(title='批量处理预约')
          i.fa.fa-hourglass-2
          span 处理
        | &nbsp;
        button#exportBooking.btn.btn-default.btn-sm(title='导出预约服务明细')
          i.fa.fa-cloud-download 导出
    .panel-body
      form#searchForm.form-horizontal
        .form-group.col-sm-3
          label.control-label.col-sm-4(for="branch")  网点:
          .col-sm-8
            select#branch.form-control(name='branch' style="width: 100%;")
        .form-group.col-sm-3
          label.control-label.col-sm-4(for="fullname")  预约人:
          .col-sm-8
            input#fullname.form-control.required(name='fullname' )
        .form-group.col-sm-3
          label.control-label.col-sm-4(for="mobile")  手机号:
          .col-sm-8
            input#mobile.form-control.required(name='mobile' )
        .form-group.col-sm-2
          label.control-label.col-sm-4(for="mobile")  处理:
          .col-sm-8
            input#status.form-control.required(type='checkbox' name='status' )
        .form-group.col-sm-1
          a#search.btn.btn-default.btn-sm(title='查询')
            i.fa.fa-search.fa-fw
            span 查询
      #tableWrapper(style="display:none;")
        table#bookingList.table.table-bordered.table-hover.table-striped
          thead
            th 网点
            th 预约人
            th 手机号
            th 预约服务项
            th 预约时间
            th 提交时间
            th 反馈内容
            th 状态
          tbody

    #handleModal.modal.fade.createInvoice(tabindex="-1", role="dialog", aria-labelledby="remarkModal", aria-hidden='true')
      .modal-dialog
        .modal-content
          .modal-header
            button.close(type="button",data-dismiss="modal", aria-label="Close")
              span(aria-hidden="true") &times;
            h4.modal-title 批量处理预约
          .modal-body
            form#feedbackForm.form-horizontal(method='post', action='/bank/booking/feedback')
              input#ids(type='hidden',name='ids')
              input#_csrf(type='hidden', name='_csrf', value=_csrf)
              .form-group
                label.control-label.col-xs-3.required 反馈内容:
                .controls.col-xs-8
                  input#feedback.form-control.required(type='text', name='feedback')
                  span#errMsg(style="color:red")
          .modal-footer
            .center-block.pull-right
            button#feedbackBtn.btn.btn-primary(type="button") 确定

//应用添加的脚本在scripts block中定义
block scripts
  script(src='//cdn.bootcss.com/datatables/1.10.11/js/jquery.dataTables.min.js')
  script(src='//cdn.bootcss.com/datatables/1.10.11/js/dataTables.bootstrap.min.js')
  script(src='//cdnjs.cloudflare.com/ajax/libs/moment.js/2.12.0/locale/zh-cn.js')
  script(src='/themes/default/plugins/datatables/dataTables.select.min.js')
  script(src='/themes/default/plugins/select2/select2.full.js')
  script.
    $(document).ready(function () {
      initSelect2("#branch","/bank/branch/getData");
      var opts = {
        "language": {
          "url": "/themes/default/plugins/datatables/Chinese.json"
        },
        autoWidth: false,
        lengthChange: true,
        searching: false,
        processing: false,
        //scrollX:true,
        select: true,
        stateSave: false,
        serverSide: true,
        deferRender: true
      };
      var t = $('#bookingList').DataTable($.extend(opts, {
        ajax: {url: '/bank/booking/datatable'},
        order: [[5, 'desc']],
        columnDefs: [
        ],
        columns: [
          {data: "branch.name", defaultContent: ''},
          {data: "user.fullname", defaultContent: ''},
          {data: "user.mobile", defaultContent: ''},
          {data: "service.serverName", defaultContent: ''},
          {
            data: "datetime", defaultContent: '', render: function (data, type, full, meta) {
            var b = moment(new Date(data));
            var date = "";
            if (data != null) {
              date = b.format("YYYY-MM-DD hh:mm:ss");
            }
            return date;
          }
          }, {
            data: "submitTime", defaultContent: '', render: function (data, type, full, meta) {
              var b = moment(new Date(data));
              var date = "";
              if (data != null) {
                date = b.format("YYYY-MM-DD hh:mm:ss");
              }
              return date;
            }
          },
          {data: "feedback", defaultContent: ''},
          {
            data: "status", defaultContent: '', render: function (data, type, full, meta) {
            var b = moment(new Date(data));
            var result = "";
            if (data == '01') {
              result = "未处理";
            } else {
              result = "已处理";
            }
            return result;
          }
          }
        ]
      })).on('draw.dt', function () {
        $("#tableWrapper").fadeIn();
      });

      //筛选
      $('#search').on("click", function (e) {
        var data = $('#searchForm').serialize();

        var TT = $('#bookingList').DataTable();
        TT.ajax.url('/bank/booking/datatable?init=1&' + data).load();
      });
      //批量处理预约内容
      $('#handle').on('click', function () {
        var datas = t.rows({selected: true}).data();
        var len = datas ? datas.length : 0;
        if (len > 0) {
          var ids = [];
          datas.each(function (d) {
            ids.push(d._id);
          });
          $('#feedbackForm #ids').val(ids);
          $('#handleModal').modal('show');
        } else {
          bootbox.alert("请选择需要处理的预约信息！");
        }
      });
      //批量处理确定
      $('#feedbackBtn').on('click', function () {
        var feedback = $("#feedback").val();
        if (feedback) {
          $("#errMsg").html("");
          $('#feedbackForm').submit();
          $('#handleModal').modal('hide');
        } else {
          $("#errMsg").text("请输入反馈内容");
        }
      });

      $('#bookingList').on('click', 'button.del', function () {
        var id = t.row($(this).parents('tr')).data()._id;
        $("#serviceDelForm #ids").val(id);
        if (id) {
          bootbox.confirm("确定要删除数据吗?", function (result) {
            if (result) {
              $("#serviceDelForm").submit();
            }
          });
        }
      });

      $('#exportBooking').on("click", function (e) {
        var data = $('#searchForm').serialize();
        window.location.href = '/bank/booking/export?' + data;
      });

    });
    //select2的使用
    function initSelect2(selectId, url) {
      $(selectId).select2({
        ajax: {
          url: url,
          dataType: 'json',
          delay: 250,
          data: function (params) {
            return {
              q: params.term
            };
          },
          processResults: function (data) {
            return {
              results: data
            };
          },
          cache: true
        },
        escapeMarkup: function (markup) {
          return markup;
        },
        minimumInputLength: 2,
        templateResult: formatRepo,
        templateSelection: formatRepoSelection
      });
    }
    function formatRepo(repo) {
      return repo.text
    }
    function formatRepoSelection(repo) {
      return repo.text
    }
