//
   Created by danne on 2015/10/24.
extends layout
block header
  link(rel="stylesheet" href="//cdn.bootcss.com/datatables/1.10.11/css/dataTables.bootstrap.min.css")
  link( rel="stylesheet" href="/themes/default/plugins/datatables/select.bootstrap.min.css" type="text/css")
  link( rel="stylesheet" href="/themes/default/plugins/select2/select2.min.css")

//应用的page title
block pageTitle
  h1 留言信息管理
    small 添加，删除，更新系统中留言信息信息

block main
  .panel
    .panel-heading.with-border
      h3.panel-title 留言信息
      .panel-tools.pull-right
        button#exportMessage.btn.btn-default.btn-sm(title='导出留言')
          i.fa.fa-cloud-download 导出
    .panel-body
      form#searchForm.form-horizontal
        .form-group.col-sm-3
          label.control-label.col-sm-4(for="branch")  网点:
          .col-sm-8
            select#branch.form-control(name='branch' style="width: 100%;")
        .form-group.col-sm-3
          label.control-label.col-sm-4(for="fullname")  用户名:
          .col-sm-8
            input#fullname.form-control.required(name='fullname' )
        .form-group.col-sm-3
          label.control-label.col-sm-4(for="mobile")  手机号:
          .col-sm-8
            input#mobile.form-control.required(name='mobile' )
        .form-group.col-sm-2
          label.control-label.col-sm-4(for="mobile") 已读:
          .col-sm-8
            input#isReaded.form-control.required(type='checkbox' name='isReaded' )
        .form-group.col-sm-1
          a#search.btn.btn-default.btn-sm(title='查询')
            i.fa.fa-search.fa-fw
            span 查询
      #tableWrapper(style="display:none;")
        table#messageList.table.table-bordered.table-hover.table-striped
          thead
            th 网点
            th 用户名
            th 手机号
            th 留言
            th 留言时间
            th 读取
            th 回复内容
            th 处理
            th.text-center(width="80") 操作
          tbody

      form#delForm(method='post', style='display:none', action='/bank/message/del')
        input#ids(type='hidden',name='ids')
        input#_csrf(type='hidden', name='_csrf', value=_csrf)
//应用添加的脚本在scripts block中定义
block scripts
  script(src='//cdn.bootcss.com/datatables/1.10.11/js/jquery.dataTables.min.js')
  script(src='//cdn.bootcss.com/datatables/1.10.11/js/dataTables.bootstrap.min.js')
  script(src='//cdnjs.cloudflare.com/ajax/libs/moment.js/2.12.0/locale/zh-cn.js')
  script(src='/themes/default/plugins/datatables/dataTables.select.min.js')
  script(src='/themes/default/plugins/select2/select2.full.js')
  script.
    $(document).ready(function () {
      initSelect2("#branch", "/bank/branch/getData");
      var opts = {
        "language": {
          "url": "/themes/default/plugins/datatables/Chinese.json"
        },
        autoWidth: false,
        lengthChange: true,
        searching: false,
        processing: false,
        //scrollX:true,
        select: true,
        stateSave: false,
        serverSide: true,
        deferRender: true
      };
      var t = $('#messageList').DataTable($.extend(opts, {
        ajax: {url: '/bank/message/datatable'},
        order: [[4, 'desc'], [5, 'asc']],
        columnDefs: [
          {
            targets: -1, visible: true, sortable: false, className: 'text-center',
            render: function (data, type, row) {
              return "<a class='btn btn-default btn-xs edit' href='/bank/message/edit/" + row._id + "'><i class='fa fa-edit'></i></a>"
                + " <button class='btn btn-default btn-xs del' type='button'><i class='fa fa-trash-o'></i></button>";
            }
          }
        ],
        columns: [
          {data: "branch.name", defaultContent: ''},
          {data: "user.fullname", defaultContent: ''},
          {data: "user.mobile", defaultContent: ''},
          {
            data: "message", defaultContent: '', render: function (data, type, full, meta) {
            var result = "";
            if (data.length >= 10) {
              result = data.substring(0, 10) + "...";
            } else {
              result = data + "...";
            }
            return result;
          }
          },
          {
            data: "datetime", defaultContent: '', className: 'text-center', render: function (data, type, full, meta) {
            var b = moment(new Date(data));
            var date = "";
            if (data != null) {
              date = b.format("YYYY-MM-DD hh:mm:ss");
            }
            return date;
          }
          },
          {
            data: "isReaded", defaultContent: '', className: 'text-center', render: function (data, type, full, meta) {
            var result = "";
            if (data) {
              result = "已读";
            } else {
              result = "未读";
            }
            return result;
          }
          },
          {
            data: "feedback", defaultContent: '', render: function (data, type, full, meta) {
            var result = "";
            if (data.length >= 10) {
              result = data.substring(0, 10) + "...";
            } else {
              result = data + "...";
            }
            return result;
          }
          },
          {
            data: "isHandle", defaultContent: '', className: 'text-center', render: function (data, type, full, meta) {
            var b = moment(new Date(data));
            var result = "";
            if (data) {
              result = "已处理";
            } else {
              result = "未处理";
            }
            return result;
          }
          },
          {data: ""}
        ]
      })).on('draw.dt', function () {
        $("#tableWrapper").fadeIn();
      });

      //筛选
      $('#search').on("click", function (e) {
        var data = $('#searchForm').serialize();

        var TT = $('#messageList').DataTable();
        TT.ajax.url('/bank/message/datatable?' + data).load();
      });
      //批量处理预约内容
      $('#handle').on('click', function () {
        var datas = t.rows({selected: true}).data();
        var len = datas ? datas.length : 0;
        if (len > 0) {
          var ids = [];
          datas.each(function (d) {
            ids.push(d._id);
          });
          $('#feedbackForm #ids').val(ids);
          $('#handleModal').modal('show');
        } else {
          bootbox.alert("请选择需要处理的预约信息！");
        }
      });
      //批量处理确定
      $('#feedbackBtn').on('click', function () {
        var feedback = $("#feedback").val();
        if (feedback) {
          $("#errMsg").html("");
          $('#feedbackForm').submit();
          $('#handleModal').modal('hide');
        } else {
          $("#errMsg").text("请输入反馈内容");
        }
      });

      $('#messageList').on('click', 'button.del', function () {
        var id = t.row($(this).parents('tr')).data()._id;
        $("#delForm #ids").val(id);
        if (id) {
          bootbox.confirm("确定要删除数据吗?", function (result) {
            if (result) {
              $("#delForm").submit();
            }
          });
        }
      });

      $('#exportMessage').on("click", function (e) {
        var data = $('#searchForm').serialize();
        window.location.href = '/bank/message/export?' + data;
      });

    });
    //select2的使用
    function initSelect2(selectId, url) {
      $(selectId).select2({
        ajax: {
          url: url,
          dataType: 'json',
          delay: 250,
          data: function (params) {
            return {
              q: params.term
            };
          },
          processResults: function (data) {
            return {
              results: data
            };
          },
          cache: true
        },
        escapeMarkup: function (markup) {
          return markup;
        },
        minimumInputLength: 2,
        templateResult: formatRepo,
        templateSelection: formatRepoSelection
      });
    }
    function formatRepo(repo) {
      return repo.text
    }
    function formatRepoSelection(repo) {
      return repo.text
    }
